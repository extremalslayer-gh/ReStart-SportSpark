document.addEventListener("DOMContentLoaded", function () {
    fetchReports();
});

function fetchReports() {
    fetch("/reports/get_my_reports/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
    console.log(JSON.stringify(data))
        const reports = data.reports;
        const grid = document.getElementById("reportsGrid");
        grid.innerHTML = ""; // очистка на случай повторной загрузки

        reports.forEach((report, index) => {
            const date = new Date(report.organization.creation_time).toLocaleDateString("ru-RU");
            if (report.organization.is_autogenerated) {
	            return;
            }
            const reportId = report.organization.id;

            const card = document.createElement("div");
            card.className = "report-card";

            card.innerHTML = `
                <div class="report-icon">
                    <img src="/static/settingurl/img/Eye.png" onclick="setReportId('${reportId}')">
                </div>
                <span class="report-date">${date}</span>
                <button class="edit-btn" data-id="${reportId}">✎</button>
            `;

            grid.appendChild(card);
        });
    })
    .catch(error => {
        console.error("Ошибка при получении отчетов:", error);
    });
}

function setReportId(reportId) {
    localStorage.setItem("report_id", reportId);
    // Можно добавить переход или другое действие, например:
    window.location.href = "/sentreport";
}


// Обработчик нажатия на ✎, с переходом на страницу редактирования
document.getElementById("reportsGrid").addEventListener('click', function (event) {
    if (event.target.classList.contains('edit-btn')) {
        const reportId = event.target.getAttribute('data-id');
        const editUrl = document.querySelector('.main-content').dataset.editUrl;

        localStorage.setItem('report_id', reportId);
        /*window.location.href = editUrl;*/
    }
});


// Функция для загрузки отчёта по ID и сохранения в localStorage
function loadReportToLocalStorage(reportId) {
    fetch("/reports/get_report/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ id: reportId }),
    })
    .then(response => response.json())
    .then(data => {
    console.log(data)
        // Сохраняем нужные данные из отчёта в localStorage
        localStorage.setItem("reportData", JSON.stringify(data));


        // Сохраняем сам ID отчёта тоже
        localStorage.setItem("report_id", reportId);

        // После успешной загрузки идём на страницу редактирования
        window.location.href = "/block_student_edit"; // или нужный тебе URL
    })
    .catch(error => {
        console.error("Ошибка при загрузке отчёта:", error);
        alert("Не удалось загрузить отчёт. Попробуйте позже.");
    });
}

// Изменяем обработчик кнопки редактирования, чтобы вызывать эту функцию
document.getElementById("reportsGrid").addEventListener('click', function (event) {
    if (event.target.classList.contains('edit-btn')) {
        const card = event.target.closest('.report-card');
        const reportId = card.querySelector(".edit-btn").getAttribute("data-id");
        console.log(reportId)

        if (!reportId) {
            alert("ID отчёта не найден");
            return;
        }

        loadReportToLocalStorage(reportId);
    }
});




document.addEventListener('DOMContentLoaded', () => {
    const profileIcon = document.getElementById('profile-icon');
    const profileMenu = document.getElementById('profile-menu');

    profileIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        profileMenu.classList.toggle('hidden');
    });

    document.addEventListener('click', () => {
        if (!profileMenu.classList.contains('hidden')) {
            profileMenu.classList.add('hidden');
        }
    });
});
